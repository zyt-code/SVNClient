<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Svns.ViewModels"
        xmlns:converters="using:Svns.Converters"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="700"
        x:Class="Svns.Views.Dialogs.DiffDialog"
        x:DataType="vm:DiffViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="{Binding FileName, StringFormat='Diff - {0}'}"
        Classes="dialog large resizable"
        Width="900"
        MinWidth="700" MinHeight="450"
        WindowStartupLocation="CenterOwner">

    <Design.DataContext>
        <vm:DiffViewModel/>
    </Design.DataContext>

    <Window.Resources>
        <converters:DiffLineTypeToBackgroundConverter x:Key="DiffBgConverter"/>
        <converters:DiffLineTypeToForegroundConverter x:Key="DiffFgConverter"/>
    </Window.Resources>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Header -->
        <Border Grid.Row="0" Classes="dialog-header">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Spacing="4">
                    <TextBlock Text="{Binding FileName}" Classes="dialog-title"/>
                    <TextBlock Text="{Binding FilePath}"
                               FontSize="12"
                               Foreground="{DynamicResource SecondaryTextBrush}"
                               TextTrimming="CharacterEllipsis"/>
                </StackPanel>

                <!-- Stats -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="+" FontSize="14" FontWeight="Bold" Foreground="#4CAF50"/>
                        <TextBlock Text="{Binding AddedLines}" FontSize="14" Foreground="#4CAF50"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="-" FontSize="14" FontWeight="Bold" Foreground="#F44336"/>
                        <TextBlock Text="{Binding RemovedLines}" FontSize="14" Foreground="#F44336"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Diff Content -->
        <Border Grid.Row="1" Classes="dialog-content">
            <Border Classes="dialog-card">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding DiffLines}" Padding="0">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="0,0"
                                        Background="{Binding Type, Converter={StaticResource DiffBgConverter}}">
                                    <Grid ColumnDefinitions="50,50,*">
                                        <!-- Old Line Number -->
                                        <Border Grid.Column="0"
                                                Background="{DynamicResource AppSecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource SidebarBorderBrush}"
                                                BorderThickness="0,0,1,0"
                                                Padding="8,2">
                                            <TextBlock Text="{Binding DisplayOldLineNumber}"
                                                       FontFamily="Consolas, Monaco, monospace"
                                                       FontSize="12"
                                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                                       HorizontalAlignment="Right"/>
                                        </Border>

                                        <!-- New Line Number -->
                                        <Border Grid.Column="1"
                                                Background="{DynamicResource AppSecondaryBackgroundBrush}"
                                                BorderBrush="{DynamicResource SidebarBorderBrush}"
                                                BorderThickness="0,0,1,0"
                                                Padding="8,2">
                                            <TextBlock Text="{Binding DisplayNewLineNumber}"
                                                       FontFamily="Consolas, Monaco, monospace"
                                                       FontSize="12"
                                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                                       HorizontalAlignment="Right"/>
                                        </Border>

                                        <!-- Content -->
                                        <Border Grid.Column="2" Padding="12,2">
                                            <TextBlock Text="{Binding Content}"
                                                       FontFamily="Consolas, Monaco, monospace"
                                                       FontSize="13"
                                                       TextWrapping="NoWrap"
                                                       Foreground="{Binding Type, Converter={StaticResource DiffFgConverter}}"/>
                                        </Border>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
        </Border>

        <!-- Footer -->
        <Border Grid.Row="2" Classes="dialog-footer">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <!-- Navigation -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                    <Button Content="◀ Previous" Command="{Binding PreviousDiffCommand}" Padding="14,8"/>
                    <TextBlock VerticalAlignment="Center" Margin="8,0"
                               Foreground="{DynamicResource SecondaryTextBrush}"
                               FontSize="12">
                        <Run Text="Hunk "/>
                        <Run Text="{Binding CurrentDiffIndex}"/>
                        <Run Text=" of "/>
                        <Run Text="{Binding TotalDiffs}"/>
                    </TextBlock>
                    <Button Content="Next ▶" Command="{Binding NextDiffCommand}" Padding="14,8"/>
                </StackPanel>

                <Button Grid.Column="2"
                        Content="Close"
                        Command="{Binding CloseCommand}"
                        Padding="24,10"
                        Classes="primary"/>
            </Grid>
        </Border>
    </Grid>

</Window>
